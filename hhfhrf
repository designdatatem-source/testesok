<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Verificador de N√∫meros</title>
<style>
  :root{
    /* PALETA CLEAN (tons de verde suaves) */
    --g50:#f7fefb;
    --g100:#effdf6;
    --g200:#dbf8ea;
    --g300:#c8f2de;
    --g400:#a7e7c9;   /* principal claro */
    --g500:#7cd9b0;
    --g600:#55c99a;
    --g700:#34b284;
    --g800:#238c68;
    --g900:#185f49;

    /* paleta das TAGS (n√£o-verdes) */
    --red-bg:#fecaca; --red-br:#ef4444; --red-tx:#7f1d1d;
    --ora-bg:#ffedd5; --ora-br:#f97316; --ora-tx:#7c2d12;
    --blu-bg:#dbeafe; --blu-br:#60a5fa; --blu-tx:#1e3a8a;
    --amb-bg:#fef3c7; --amb-br:#f59e0b; --amb-tx:#78350f;

    --bgA:#f6fff8; --bgB:#ecfff3; --card:#ffffff; --border:#e5e7eb; --muted:#334155; --text:#0f172a;
    --shadow-1:0 6px 16px rgba(0,0,0,.05), 0 1px 3px rgba(0,0,0,.04);
    --shadow-2:0 4px 12px rgba(0,0,0,.05);

    /* Bord√¥ para o aviso ultradiscreto */
    --bordo:#7a2e2e;
  }
  *{box-sizing:border-box}
  body{ font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding:40px; background:linear-gradient(120deg,var(--bgA),var(--bgB)); color:var(--text); line-height:1.5; }

  /* ===== HERO (cabe√ßalho) ===== */
  .hero{
    background:var(--g50);
    border:1px solid var(--g200);
    border-radius:22px;
    padding:22px;
    box-shadow:var(--shadow-2);
    margin-bottom:16px;
  }
  .hero-title{
    display:flex; align-items:center; justify-content:center; gap:12px;
    margin-bottom:10px; position:relative;
  }
  .hero-title h1{ margin:0; font-size:36px; line-height:1.1; font-weight:800; color:var(--g700); letter-spacing:.2px; }
  /* Easter egg quase impercept√≠vel */
  .watermark{
    position:absolute; right:10px; bottom:-6px;
    font-size:10px; font-weight:700; letter-spacing:.6px;
    color:#0f3d2e; opacity:.25; user-select:none; pointer-events:none;
  }
  .hero-stats{ display:grid; grid-template-columns:repeat(6, minmax(160px, 1fr)); gap:10px; }
  @media (max-width:1100px){ .hero-stats{ grid-template-columns:repeat(3, minmax(160px, 1fr)); } }
  @media (max-width:640px){  .hero-stats{ grid-template-columns:repeat(2, minmax(150px, 1fr)); } }

  .chip{
    display:flex; align-items:center; gap:10px;
    background:#fff; border:1px solid var(--g200);
    border-radius:14px; padding:10px 12px; box-shadow:var(--shadow-2);
    position:relative; overflow:visible; outline:none;
  }
  .chip::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-radius:12px 0 0 12px; opacity:.75;
  }
  .chip .icon{ font-size:18px; }
  .chip .text{ display:flex; flex-direction:column; line-height:1.15 }
  .chip .label{ font-size:11px; font-weight:700; color:#0f3d2e }
  .chip .value{ font-size:20px; font-weight:900; color:#0e3a29 }
  .chip-total::before{ background:var(--g400) }
  .chip-unicos::before{ background:var(--g400) }
  .chip-dup::before{ background:#f97316 }
  .chip-bloq::before{ background:#ef4444 }
  .chip-inv::before{ background:#f59e0b }
  .chip-hist::before{ background:#60a5fa }

  /* Tooltips */
  .tooltip-host{ position:relative; }
  .tooltip-host[data-tip]::after{
    content: attr(data-tip);
    position:absolute; left:50%; bottom:100%;
    transform: translate(-50%, -10px) scale(.98);
    background: rgba(15,23,42,.96); color:#fff;
    padding:8px 10px; font-size:12px; font-weight:600;
    border-radius:8px; box-shadow:0 8px 18px rgba(0,0,0,.22);
    white-space:normal; text-align:center; width:max-content; max-width:260px;
    opacity:0; visibility:hidden; pointer-events:none;
    transition: opacity .15s ease, transform .15s ease;
    z-index:5;
  }
  .tooltip-host[data-tip]::before{
    content:""; position:absolute; left:50%; bottom:100%;
    transform: translate(-50%, -2px);
    border-width:6px; border-style:solid;
    border-color: rgba(15,23,42,.96) transparent transparent transparent;
    opacity:0; visibility:hidden; transition: opacity .15s ease;
    z-index:5;
  }
  .tooltip-host:hover::after,
  .tooltip-host:focus-visible::after,
  .tooltip-host:hover::before,
  .tooltip-host:focus-visible::before{
    opacity:1; visibility:visible;
    transform: translate(-50%, -14px) scale(1);
  }

  /* Se√ß√µes */
  .collapse-section{ background:#fff; border:1px solid var(--border); border-radius:20px; margin-top:22px; overflow:hidden; box-shadow:var(--shadow-2); }
  .collapse-header{
    padding:14px 18px; font-weight:900; cursor:pointer; font-size:16px; color:#0f3d2e;
    background:linear-gradient(90deg,var(--g300),var(--g400)); user-select:none; border-bottom:1px solid var(--g200);
  }
  .collapse-body{ display:none; padding:16px; background:#fff; animation:fadeIn .25s ease both }

  /* Bot√µes */
  .btn{
    border:0; cursor:pointer; font-weight:700; letter-spacing:.1px;
    color:#083b2a; background:var(--g400);
    box-shadow:var(--shadow-1);
    transition: transform .08s ease, box-shadow .18s ease, filter .18s ease, background .18s ease;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 12px 30px rgba(0,0,0,.10), 0 4px 10px rgba(0,0,0,.06); filter:saturate(1.02) brightness(1.03); }
  .btn:active{ transform:translateY(0) scale(.99); box-shadow:var(--shadow-1); }
  .btn:focus-visible{ outline:3px solid var(--g300); outline-offset:2px; }

  .btn-lg{ padding:12px 18px; border-radius:14px; font-size:14px; }
  .btn-md{ padding:10px 14px; border-radius:12px; font-size:13px; background:var(--g300); color:#0f3d2e; }
  .btn-sm{ padding:8px 12px;  border-radius:10px; font-size:12px; background:var(--g200); color:#0f3d2e; }

  .btn-prim{ background:linear-gradient(180deg,var(--g300),var(--g400)); color:#083b2a; }
  .btn-sec { background:var(--g300); color:#0f3d2e; }
  .btn-ghost{ background:#fff; color:#0f3d2e; border:1.5px solid var(--g200); }
  .btn-ghost:hover{ background:var(--g50); }

  .btn-file{ display:inline-flex } input[type="file"]{ display:none }

  /* Inputs */
  textarea{ width:100%; font-size:15px; padding:12px; resize:vertical; border:1px solid var(--border); border-radius:12px; background:#fff; box-shadow:var(--shadow-2); }
  #entrada,#bloqueados{height:180px}
  .botoes{ margin-top:12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

  .grupo-config{ margin-top:14px; display:flex; flex-wrap:wrap; gap:12px; align-items:center;
    background:linear-gradient(90deg, rgba(124,217,176,.12), rgba(85,201,154,.12));
    border:1px solid var(--border); padding:14px; border-radius:18px; box-shadow:var(--shadow-2);
  }
  .grupo-config .txt{ font-weight:900; color:var(--g800) }
  .grupo-config input[type="number"]{ width:120px; padding:10px 12px; border:1.5px solid var(--g200); border-radius:12px; font-size:14px; background:#fff; box-shadow:var(--shadow-2); }
  .grupo-config span{ color:var(--g800) }
  .opts-toggle{ margin-left:auto; }
  .opts-toggle .chev{ transition:transform .2s ease } .opts-open .opts-toggle .chev{ transform:rotate(90deg) }
  .opts-collapsible{ width:100%; display:none; margin-top:10px; padding-top:10px; border-top:2px dashed var(--g300); animation:fadeIn .25s ease both; }
  .opts-open .opts-collapsible{ display:flex; flex-wrap:wrap; gap:12px }
  .pill{ display:inline-flex; align-items:center; gap:10px; font-size:14px; color:var(--g900); background:var(--g50); border:2px solid var(--g200); padding:10px 14px; border-radius:999px; font-weight:800; box-shadow:var(--shadow-2); }
  .pill input{ accent-color:var(--g600); width:18px; height:18px }

  /* Grupos */
  .group-box{ background:#fff; border:1px solid var(--border); margin-bottom:14px; border-radius:16px; overflow:hidden; box-shadow:var(--shadow-2); animation:popIn .25s ease both; }
  .group-header{ position:relative; display:flex; justify-content:space-between; align-items:center; background:#fff; color:var(--g900); padding:12px 14px 12px 18px; font-weight:900; font-size:15px; cursor:pointer; border-bottom:1px solid var(--border); }
  .group-header::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:8px; background:var(--g400); }
  .group-actions-inline{ display:flex; align-items:center; gap:8px; }
  .group-body{ display:none; padding:12px 14px; animation:fadeIn .25s ease both }
  .group-box.done{ background:#f4fcf8; border-color:#cfeee0; }
  .group-box.done .group-header{ background:#f9fefa; }
  .group-box.done .group-header::before{ background:var(--g500); }
  .check-btn{ width:34px; height:34px; border-radius:50%; background:#fff; color:#0f3d2e; border:1.5px solid var(--g200); }
  .group-box.done .check-btn{ background:var(--g500); color:#fff; border-color:var(--g500); }

  .group-metrics{ display:grid; grid-auto-flow:column; grid-template-columns:repeat(3,max-content); justify-content:flex-start; gap:10px 16px; margin-bottom:10px; align-items:end; background:var(--g50); border:1px dashed var(--g300); border-radius:12px; padding:8px 10px; }
  .metric{ display:grid; gap:4px } .metric label{ font-size:12px; font-weight:900; color:var(--muted) }
  .metric input{ width:140px; height:34px; padding:6px 8px; border:1.5px solid var(--g200); border-radius:10px; font-size:14px; background:#fff; box-shadow:var(--shadow-2); }
  .input-warn{ border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,.15) !important; }

  /* Tabela */
  table{ width:100%; border-collapse:collapse; margin-top:8px }
  th,td{ padding:10px; text-align:center }
  th{ background:#fff; border-bottom:1px solid var(--border); color:#0f3d2e; font-size:13px; font-weight:900 }
  #tabela tbody tr{ border-bottom:1px solid var(--border); transition:background .15s ease, transform .05s ease }
  #tabela tbody tr:hover{ background:var(--g50) }
  #tabela tbody td:nth-child(3){ background:transparent; box-shadow:none; border-radius:0; }

  /* TAGS */
  .tag{ display:inline-block; padding:6px 12px; border-radius:999px; font-size:12px; font-weight:900; border:1px solid transparent; }
  .tag-unico{             background:var(--g300);  color:#0f3d2e; border-color:var(--g500); }
  .tag-bloqueado{         background:var(--red-bg); color:var(--red-tx); border-color:var(--red-br); }
  .tag-duplicado{         background:var(--ora-bg); color:var(--ora-tx); border-color:var(--ora-br); }
  .tag-ja-higienizado{    background:var(--blu-bg); color:var(--blu-tx); border-color:var(--blu-br); }
  .tag-possivel-invalido{ background:var(--amb-bg); color:var(--amb-tx); border-color:var(--amb-br); }

  .filtro-container{ display:flex; align-items:center; gap:10px; margin-bottom:10px }
  #filtroTexto, #filtroStatus{ padding:10px 12px; border:1.5px solid var(--g200); border-radius:12px; font-size:14px; background:#fff; box-shadow:var(--shadow-2); }
  #filtroTexto{ width:220px }

  /* Totais */
  .totais-grid{ display:grid; grid-template-columns:repeat(3,minmax(180px,1fr)); gap:12px }
  .total-card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:14px; position:relative; box-shadow:var(--shadow-2) }
  .total-card::before{ content:""; position:absolute; left:0; top:0; height:6px; width:100%; background:var(--g400); border-radius:16px 16px 0 0; }
  .total-card .label{ font-size:12px; font-weight:900; color:var(--muted); margin:8px 0 6px 0 }
  .total-card .value{ font-size:24px; font-weight:1000; color:var(--g900) }

  /* Aviso ultradiscreto (texto apenas) */
  .fine-print{
    margin-top:18px;
    text-align:center;
    color:var(--bordo);
    opacity:.45;
    font-size:12px;
    font-weight:700;
    letter-spacing:.3px;
    user-select:none;
  }

  /* Bot√£o topo */
  #btnTopo{ display:none; position:fixed; bottom:30px; right:30px; z-index:99; font-size:22px; background:var(--g600); color:#fff; border:0; outline:none; padding:12px 16px; border-radius:50%; cursor:pointer; box-shadow:var(--shadow-1) }

  @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
  @keyframes popIn{ from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)} }
</style>
</head>
<body>

  <!-- ===== HERO ===== -->
  <header class="hero">
    <div class="hero-title">
      <h1>Verificador de N√∫meros</h1>
      <span class="watermark" aria-hidden="true">dev.Mozart</span>
    </div>
    <div id="contadorStatusUI" class="hero-stats"></div>
  </header>

  <textarea id="entrada" placeholder="Cole aqui os n√∫meros de telefone (um por linha, v√≠rgula, ponto e v√≠rgula, TAB ou |)‚Ä¶"></textarea>

  <div class="grupo-config" id="grpConfig">
    <span class="txt">Separar em grupos de</span>
    <input type="number" id="tamanhoGrupo" value="150" min="1">
    <span>n√∫meros</span>

    <button type="button" class="btn btn-prim btn-lg opts-toggle" onclick="toggleOpts()">
      <span class="chev">‚ñ∏</span> Op√ß√µes
    </button>

    <div class="opts-collapsible" id="optsCol">
      <label class="pill"><input type="checkbox" id="ignorarHistorico" checked> Ignorar ‚Äúj√° higienizados‚Äù no c√°lculo</label>
      <label class="pill"><input type="checkbox" id="incluirInvalidos" checked> Incluir ‚Äúposs√≠veis inv√°lidos‚Äù nos grupos</label>
    </div>
  </div>

  <div class="botoes">
    <button class="btn btn-prim btn-lg" onclick="verificar()">Verificar</button>
    <button class="btn btn-sec btn-lg" onclick="toggleBloqueados()">Bloqueados</button>
    <button class="btn btn-sec btn-lg" onclick="confirmarAtualizacao()">Atualizar</button>
    <button class="btn btn-sec btn-lg" onclick="salvarTudo()">Salvar tudo</button>
    <label for="arquivoInput" class="btn btn-sec btn-lg btn-file">Escolher Arquivo</label>
    <input type="file" id="arquivoInput" accept=".json" onchange="importarTudo(event)" />
  </div>

  <div id="bloqueados-container" style="display:none;">
    <h3 style="margin:12px 0 10px 0;color:var(--g800);">N√∫meros bloqueados:</h3>
    <textarea id="bloqueados" placeholder="Cole aqui os n√∫meros bloqueados‚Ä¶ (aceita quebra de linha, v√≠rgula, ;, TAB, |)"></textarea>
  </div>

  <div class="collapse-section">
    <div class="collapse-header" onclick="toggleSection('tabelaVerificados')">Tabela de N√∫meros Verificados</div>
    <div class="collapse-body" id="tabelaVerificados">
      <div class="filtro-container">
        <input id="filtroTexto" type="text" placeholder="Filtrar‚Ä¶" oninput="filtrarTabela()"/>
        <select id="filtroStatus" onchange="filtrarTabela()">
          <option value="">Todos os status</option>
        </select>
      </div>
      <table id="tabela">
        <thead>
          <tr>
            <th>N√∫mero Original</th>
            <th>N√∫mero Limpo</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="collapse-section">
    <div class="collapse-header" onclick="toggleSection('numerosLimpos')">N√∫meros √∫nicos e limpos</div>
    <div class="collapse-body" id="numerosLimpos">
      <div class="group-actions" style="margin-bottom:10px;">
        <button class="btn btn-prim btn-md" onclick="copiarTodosGrupos()">Copiar todos os grupos</button>
      </div>
      <div id="grupos-container"></div>
    </div>
  </div>

  <div class="collapse-section">
    <div class="collapse-header" onclick="toggleSection('totaisGrupos')">Totais dos grupos</div>
    <div class="collapse-body" id="totaisGrupos">
      <div class="totais-grid">
        <div class="total-card"><div class="label">Total dos Destinat√°rios</div><div class="value" id="somaTotalDest">0</div></div>
        <div class="total-card"><div class="label">Mensagens Enviadas</div><div class="value" id="somaEnviadas">0</div></div>
        <div class="total-card"><div class="label">N√∫meros Inv√°lidos</div><div class="value" id="somaInvalidos">0</div></div>
      </div>
      <div style="margin-top:12px;">
        <button class="btn btn-ghost btn-sm" onclick="exportarTotaisCSV()">Exportar planilha (CSV)</button>
      </div>
    </div>
  </div>

  <!-- Aviso centralizado, bord√¥, sem fundo/borda -->
  <footer class="fine-print">
    Essa dashboard foi desenvolvida exclusivamente para uso do Marketing ‚Äî Datatem, n√£o podendo ser compartilhada ou utilizada sem aprova√ß√£o pr√©via.
  </footer>

<script>
  /* Limpeza ‚Äúafrouxada‚Äù + regra do prefixo 0 */
  function limparNumero(numero){
    let d = numero.replace(/\D/g,"");
    if(d.startsWith("55")) d = d.slice(2);
    if(d.startsWith("0")){
      const sem0 = d.slice(1);
      if (sem0.length === 10 || sem0.length === 11) d = sem0;
      else if (/^0\d{2}\d{8,9}$/.test(d)) d = sem0;
    }
    return d;
  }

  /* >>> NOVO: normaliza√ß√£o can√¥nica para compara√ß√£o de bloqueados (aceita varia√ß√µes +55, 0055, 0DDD, etc.) */
  function normalizarParaComparacao(numero){
    let d = String(numero || '').replace(/\D/g, '');
    while (d.startsWith('00')) d = d.slice(2);
    while (d.startsWith('55') && d.length > 11) d = d.slice(2);
    while (d.startsWith('0')  && d.length > 11) d = d.slice(1);
    if (d.length > 11) d = d.slice(-11);
    return d;
  }

  function splitEntrada(t){ return t.split(/[\n,;|\t]+/).map(n=>n.trim()).filter(Boolean); }
  function toggleBloqueados(){ const c=document.getElementById("bloqueados-container"); c.style.display=c.style.display==="none"?"block":"none"; }
  function toggleSection(id){ const el=document.getElementById(id); el.style.display=el.style.display==="none"?"block":"none"; }
  function toggleGrupo(h){ const b=h.nextElementSibling; b.style.display=(b.style.display==="none"||b.style.display==="")?"block":"none"; }
  function toggleOpts(){ document.getElementById("grpConfig").classList.toggle("opts-open"); }

  /* Hist√≥rico + op√ß√µes persistentes */
  let historicoNumeros = JSON.parse(localStorage.getItem("numerosJaCopiados") || "[]");
  function registrarNumerosCopiados(lista){
    let mudou=false; lista.forEach(n=>{ if(!historicoNumeros.includes(n)){ historicoNumeros.push(n); mudou=true; } });
    if(mudou) localStorage.setItem("numerosJaCopiados", JSON.stringify(historicoNumeros));
  }
  function loadOptions(){
    const ig=document.getElementById("ignorarHistorico");
    const inv=document.getElementById("incluirInvalidos");
    const sIg=localStorage.getItem("optIgnorarHistorico");
    const sInv=localStorage.getItem("optIncluirInvalidos");
    ig.checked = sIg===null ? true : (sIg==="true");
    inv.checked = sInv===null ? true : (sInv==="true");
    ig.addEventListener("change", ()=>localStorage.setItem("optIgnorarHistorico", ig.checked));
    inv.addEventListener("change", ()=>localStorage.setItem("optIncluirInvalidos", inv.checked));
  }

  function statusToClass(s){ return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/\s+/g,"-"); }

  /* Sugest√µes E/E/I */
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function valOrNull(v){ const x=parseInt(v,10); return isNaN(x)?null:x; }
  function atualizarSugestoesDoGrupo(box){
    const tInp=box.querySelector(".met-total");
    const eInp=box.querySelector(".met-enviadas");
    const iInp=box.querySelector(".met-invalidos");
    const T = valOrNull(tInp.value) ?? 0;
    const E = eInp.value.trim()==="" ? null : valOrNull(eInp.value);
    const I = iInp.value.trim()==="" ? null : valOrNull(iInp.value);
    eInp.placeholder = ""; iInp.placeholder = "";
    if (E!==null && I===null) iInp.placeholder = String(clamp(T - E, 0, T));
    else if (I!==null && E===null) eInp.placeholder = String(clamp(T - I, 0, T));
    const sum = (E??0) + (I??0);
    const over = sum > T && T>0;
    [eInp,iInp].forEach(inp=> inp.classList.toggle("input-warn", over));
  }
  function anexarListenersMetricas(box){
    const t=box.querySelector(".met-total");
    const e=box.querySelector(".met-enviadas");
    const i=box.querySelector(".met-invalidos");
    ["input","change"].forEach(ev=>{
      t.addEventListener(ev, ()=>atualizarSugestoesDoGrupo(box));
      e.addEventListener(ev, ()=>atualizarSugestoesDoGrupo(box));
      i.addEventListener(ev, ()=>atualizarSugestoesDoGrupo(box));
    });
    atualizarSugestoesDoGrupo(box);
  }

  /* Chips do topo */
  function renderHeaderStats(meta){
    const host = document.getElementById("contadorStatusUI");
    const chips = [
      {cls:'total', icon:'üì•', label:'Total colado', value: meta.totalColado, tip:'Quantidade de linhas/n√∫meros informados na entrada, antes de qualquer filtro.'},
      {cls:'unicos', icon:'‚úÖ', label:'√önicos', value: meta.unico, tip:'V√£o para os grupos: v√°lidos (10‚Äì11 d√≠gitos), n√£o bloqueados, n√£o duplicados e (se marcado) ignorando ‚Äúj√° higienizados‚Äù.'},
      {cls:'dup', icon:'üîÅ', label:'Duplicados', value: meta.duplicado, tip:'N√∫meros que apareceram mais de uma vez depois da limpeza.'},
      {cls:'bloq', icon:'üö´', label:'Bloqueados', value: meta.bloqueado, tip:'Coincidem com a lista de ‚ÄúN√∫meros bloqueados‚Äù.'},
      {cls:'inv', icon:'‚ö†Ô∏è', label:'Poss√≠veis inv√°lidos', value: meta.possivelInvalido, tip:'Fora do padr√£o 10‚Äì11 d√≠gitos ap√≥s limpeza.'},
      {cls:'hist', icon:'üßπ', label:'J√° higienizados', value: `${meta.jaNoHistorico}${meta.ign ? ' (ign.)' : ''}`, tip: meta.ign ? 'No hist√≥rico e ignorados (op√ß√£o ligada).' : 'No hist√≥rico e considerados (op√ß√£o desligada).'}
    ];
    host.innerHTML = chips.map(c => `
      <div class="chip chip-${c.cls} tooltip-host" tabindex="0" data-tip="${c.tip}">
        <span class="icon">${c.icon}</span>
        <div class="text"><span class="label">${c.label}</span><span class="value">${c.value}</span></div>
      </div>`).join('');
  }

  /* Estado "feito" por grupo */
  function toggleGrupoFeito(btn){
    event.stopPropagation();
    const box = btn.closest('.group-box');
    const key = box.dataset.key;
    box.classList.toggle('done');
    const done = box.classList.contains('done');
    btn.setAttribute('aria-pressed', done);
    const mem = resumosPorGrupo[key] || {};
    mem.done = done; resumosPorGrupo[key] = mem;
    localStorage.setItem('resumosPorGrupo', JSON.stringify(resumosPorGrupo));
  }

  /* L√≥gica principal */
  let resumosPorGrupo = JSON.parse(localStorage.getItem("resumosPorGrupo") || "{}");
  function keyDoGrupo(arr){ const s=arr.join(","); return "g|"+s.length+"|"+s.slice(0,50)+"|"+s.slice(-50); }
  function atualizarMetricas(input){
    const box=input.closest(".group-box"); const key=box.dataset.key;
    resumosPorGrupo[key]={
      ...(resumosPorGrupo[key]||{}),
      total:parseInt(box.querySelector(".met-total").value||"0",10),
      enviadas:parseInt(box.querySelector(".met-enviadas").value||"0",10),
      invalidos:parseInt(box.querySelector(".met-invalidos").value||"0",10)
    };
    localStorage.setItem("resumosPorGrupo", JSON.stringify(resumosPorGrupo));
    atualizarTotais();
  }

  function verificar(){
    const ignorarHistorico = document.getElementById("ignorarHistorico").checked;
    const incluirInvalidos  = document.getElementById("incluirInvalidos").checked;

    const entrada = splitEntrada(document.getElementById("entrada").value);

    /* NOVO: construir Set can√¥nico de bloqueados para compara√ß√£o robusta */
    const bloqueadosSet = new Set(
      splitEntrada(document.getElementById("bloqueados").value)
        .map(normalizarParaComparacao)
        .filter(Boolean)
    );

    const tbody=document.querySelector("#tabela tbody");
    const gruposContainer=document.getElementById("grupos-container");
    const filtroTexto=document.getElementById("filtroTexto");
    tbody.innerHTML=""; gruposContainer.innerHTML=""; if(filtroTexto) filtroTexto.value="";

    const numerosMap=new Map(); const pushGrp=[];
    const counts={ totalColado:entrada.length, unico:0, duplicado:0, bloqueado:0, jaHigienizado:0, possivelInvalido:0 };

    entrada.forEach(original=>{
      const limpo = limparNumero(original);
      const canon = normalizarParaComparacao(original);
      const foiHigienizado = historicoNumeros.includes(limpo);
      const jaVisto = numerosMap.has(limpo);

      numerosMap.set(limpo,(numerosMap.get(limpo)||0)+1);

      /* PRIORIDADE: bloqueado primeiro (usando Set can√¥nico) */
      const estaBloqueado = bloqueadosSet.has(canon) || bloqueadosSet.has(normalizarParaComparacao(limpo));

      const invalido = (limpo.length<10 || limpo.length>11);

      let status = "√önico";
      if (estaBloqueado) {
        status = "Bloqueado";
      } else if (invalido) {
        status = "Poss√≠vel inv√°lido";
      } else if (jaVisto) {
        status = "Duplicado";
      } else if (!ignorarHistorico && foiHigienizado) {
        status = "J√° higienizado";
      }

      const cls=statusToClass(status);
      const badge=`<span class="tag tag-${cls}">${status}</span>`;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${original}</td><td>${limpo}</td><td>${badge}</td>`;
      tbody.appendChild(tr);

      /* Contadores + push (jamais empurrar bloqueado) */
      if(status==="Bloqueado") counts.bloqueado++;
      else if(status==="Duplicado") counts.duplicado++;
      else if(status==="J√° higienizado") counts.jaHigienizado++;
      else if(status==="Poss√≠vel inv√°lido"){ counts.possivelInvalido++; if(incluirInvalidos) pushGrp.push(limpo); }
      else { counts.unico++; pushGrp.push(limpo); }
    });

    const jaNoHistorico=entrada.filter(n=>historicoNumeros.includes(limparNumero(n))).length;

    renderHeaderStats({
      totalColado: counts.totalColado,
      unico: counts.unico,
      duplicado: counts.duplicado,
      bloqueado: counts.bloqueado,
      possivelInvalido: counts.possivelInvalido,
      jaNoHistorico,
      ign: ignorarHistorico
    });

    const valorCampo=parseInt(document.getElementById("tamanhoGrupo").value||"150",10);
    const grupoTamanho=Math.max(1,isNaN(valorCampo)?150:valorCampo);

    let idx=1;
    for(let i=0;i<pushGrp.length;i+=grupoTamanho){
      const grupo=pushGrp.slice(i,i+grupoTamanho);
      const box=document.createElement("div"); box.className="group-box";
      const key=keyDoGrupo(grupo); box.dataset.key=key;
      const mem=resumosPorGrupo[key]||{}; const totalAuto=grupo.length;

      box.innerHTML=`
        <div class="group-header" onclick="toggleGrupo(this)">
          <span>Grupo ${idx} (${grupo.length} n√∫meros)</span>
          <div class="group-actions-inline">
            <button class="btn btn-ghost btn-sm check-btn" title="Marcar como conclu√≠do" onclick="toggleGrupoFeito(this)">‚úî</button>
            <button class="btn btn-prim btn-sm copiar-btn" onclick="event.stopPropagation(); copiarGrupo(this)">Copiar grupo</button>
          </div>
        </div>
        <div class="group-body" style="display:none">
          <div class="group-metrics">
            <div class="metric">
              <label>Total dos Destinat√°rios</label>
              <input type="number" class="met-total" value="${mem.total ?? totalAuto}" min="0" oninput="atualizarMetricas(this)">
            </div>
            <div class="metric">
              <label>Mensagens Enviadas</label>
              <input type="number" class="met-enviadas" value="${mem.enviadas ?? ''}" min="0" oninput="atualizarMetricas(this)">
            </div>
            <div class="metric">
              <label>N√∫meros Inv√°lidos</label>
              <input type="number" class="met-invalidos" value="${mem.invalidos ?? ''}" min="0" oninput="atualizarMetricas(this)">
            </div>
          </div>
          <textarea rows="5" readonly>${grupo.join("\n")}</textarea>
        </div>`;
      if(mem.done) box.classList.add('done');
      document.getElementById("grupos-container").appendChild(box);
      anexarListenersMetricas(box);
      idx++;
    }

    atualizarOpcoesStatus();
    atualizarTotais();
  }

  function filtrarTabela(){
    const termo=(document.getElementById("filtroTexto").value||"").toLowerCase();
    const statusSel=document.getElementById("filtroStatus").value;
    document.querySelectorAll("#tabela tbody tr").forEach(tr=>{
      const txt=tr.innerText.toLowerCase();
      const st=(tr.querySelector(".tag")?.textContent)||"";
      const ok=(termo===""||txt.includes(termo)) && (statusSel===""||st===statusSel);
      tr.style.display=ok?"":"none";
    });
  }

  function atualizarOpcoesStatus(){
    const sel=document.getElementById("filtroStatus");
    const prev=sel.value; const set=new Set();
    document.querySelectorAll("#tabela tbody .tag").forEach(t=>set.add(t.textContent.trim()));
    sel.innerHTML='<option value="">Todos os status</option>';
    Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR')).forEach(s=>{
      const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
    });
    if(prev && Array.from(sel.options).some(o=>o.value===prev)) sel.value=prev;
    else if(Array.from(sel.options).some(o=>o.value==='√önico')) sel.value='√önico';
    filtrarTabela();
  }

  function atualizarTotais(){
    let total=0,enviadas=0,invalidos=0;
    document.querySelectorAll(".group-box").forEach(box=>{
      total    += parseInt(box.querySelector(".met-total")?.value || "0",10);
      enviadas += parseInt(box.querySelector(".met-enviadas")?.value || "0",10);
      invalidos+= parseInt(box.querySelector(".met-invalidos")?.value || "0",10);
    });
    document.getElementById("somaTotalDest").textContent=total;
    document.getElementById("somaEnviadas").textContent=enviadas;
    document.getElementById("somaInvalidos").textContent=invalidos;
  }

  /* Exportar CSV */
  function exportarTotaisCSV(){
    const linhas = [];
    linhas.push(['Grupo','Total dos Destinat√°rios','Mensagens Enviadas','N√∫meros Inv√°lidos']);
    let sumT=0, sumE=0, sumI=0, idx=1;

    document.querySelectorAll('.group-box').forEach(box=>{
      const t = parseInt(box.querySelector('.met-total')?.value || '0',10);
      const e = parseInt(box.querySelector('.met-enviadas')?.value || '0',10);
      const i = parseInt(box.querySelector('.met-invalidos')?.value || '0',10);
      linhas.push([idx, t, e, i]);
      sumT += t; sumE += e; sumI += i; idx++;
    });

    linhas.push([]);
    linhas.push(['Totais gerais', sumT, sumE, sumI]);

    const csv = linhas.map(row=> row.map(val=>{
      const s = (val===undefined || val===null) ? '' : String(val);
      const precisaAspas = /[;"\n]/.test(s);
      const sEsc = s.replace(/"/g,'""');
      return precisaAspas ? `"${sEsc}"` : sEsc;
    }).join(';')).join('\n');

    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'totais-grupos.csv';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  function copiarGrupo(btn){
    const ta=btn.closest(".group-box").querySelector("textarea");
    ta.select();
    const lista=ta.value.trim().split("\n").filter(Boolean);
    const copy=(t)=>navigator.clipboard?navigator.clipboard.writeText(t):document.execCommand("copy");
    copy(ta.value); registrarNumerosCopiados(lista); alert("Grupo copiado para a √°rea de transfer√™ncia!");
  }
  function copiarTodosGrupos(){
    const areas=[...document.querySelectorAll("#grupos-container textarea")];
    const textos=areas.map(t=>t.value.trim()).join("\n\n");
    const todos=areas.flatMap(t=>t.value.trim().split("\n").filter(Boolean));
    const copy=(t)=>navigator.clipboard?navigator.clipboard.writeText(t):(()=>{ const ta=document.createElement("textarea"); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); return Promise.resolve(); })();
    copy(textos).then(()=>{ registrarNumerosCopiados(todos); alert("Grupos copiados para a √°rea de transfer√™ncia!"); });
  }

  function confirmarAtualizacao(){
    if(confirm("Deseja limpar todos os dados da tela?")){
      document.getElementById("entrada").value="";
      document.getElementById("bloqueados").value="";
      document.querySelector("#tabela tbody").innerHTML="";
      document.getElementById("grupos-container").innerHTML="";
      document.getElementById("contadorStatusUI").innerHTML="";
      const t=document.getElementById("filtroTexto"); if(t) t.value="";
      atualizarOpcoesStatus(); atualizarTotais();
    }
  }
  function salvarTudo(){
    const entrada=splitEntrada(document.getElementById("entrada").value);
    const bloqueados=splitEntrada(document.getElementById("bloqueados").value);
    const grupos=[...document.querySelectorAll("#grupos-container textarea")].map(t=>t.value.trim().split("\n").filter(Boolean));
    const dados={entrada,bloqueados,grupos};
    const blob=new Blob([JSON.stringify(dados,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="numeros-verificados.json"; a.click(); URL.revokeObjectURL(url);
  }
  function importarTudo(e){
    const f=e.target.files[0]; if(!f) return; const r=new FileReader();
    r.onload=function(ev){ try{
      const data=JSON.parse(ev.target.result);
      document.getElementById("contadorStatusUI").innerHTML="";
      document.getElementById("entrada").value=(data.entrada||[]).join("\n");
      document.getElementById("bloqueados").value=(data.bloqueados||[]).join("\n");
      verificar();
    }catch(_){ alert("Erro ao importar arquivo. Verifique se √© um JSON v√°lido."); } };
    r.readAsText(f);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    loadOptions();
    document.getElementById("grpConfig").classList.remove("opts-open");
  });

  function voltarAoTopo(){ window.scrollTo({top:0, behavior:'smooth'}) }
  window.onscroll=function(){ document.getElementById("btnTopo").style.display = document.documentElement.scrollTop>300?"block":"none"; };
</script>

<button id="btnTopo" onclick="voltarAoTopo()" title="Voltar ao topo">‚ñ≤</button>
</body>
</html>
